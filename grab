#!/usr/bin/env node
var fs = require('fs');
    child_process = require('child_process'),
    path = require('path'),
    async = require('async'), 
    webshot = require('webshot');

var usage = "Usage $0 <inputfile> <outputdir>",
    argv = require('yargs')
    .usage(usage)
    .help("h")
    .alias("h", "help")
    .demand(2, "You must supply and input file and and output directory")
    .describe("c", "cookie file (output from Cookie Inspector export)")
    .alias("c", "cookie-jar")
    .boolean('v')
    .describe("v", "More output")
    .alias("v", "verbose")
    .argv;

var inputFile = argv._[0];
if (! fs.existsSync(inputFile)) {
    console.log("Input file '" + inputFile + "' does not exist");
    process.exit()
}


var outputDir = argv._[1];
if (! fs.existsSync(outputDir)) {
    console.log("Output directory does not exist");
    process.exit()
}

function parseCookieFile(file) {
    // Takes a file generated by Cookie Inspector and reads it in,
    // returning just a list of key value pairs for cookies
    var fullFile = path.resolve(file), // make it absolute
        cookies = require(fullFile),
        out = [];
    /*
    cookies.forEach(function(cookie) {
        out.push(cookie.name + '=' + encodeURIComponent(cookie.value));
    });
    
    sout = out.join(';');
    console.log(sout);
    return sout;
    */
    return cookies;
}
if (argv.c) {
    var cookies = parseCookieFile(argv.c);
} else {
    var cookies = '';
}


function capturePage(url, file) {
    console.log("Downloading " + url);

    var url ="http://www.airbnb.com";
    var args = ["--shot-size=page/page",
                "--customer-header=Cookie: " + cookieString,
                url,
                file],
        out = child_process.execFileSync("webshot").toString()
    if (argv.v) {
        console.log(out)
    }

    console.log("Screenshot saved to " + file);
}

var resids = fs.readFileSync(inputFile).toString().split("\n");
resids.shift(); // first one is the CSV header

async.eachSeries(resids, function (resid, callback) {
    resid = resid.trim()
    console.log("Grabbing reservation '" + resid + "'");
    var outputFile = outputDir + '/' + resid + '.png',
        url = "https://admin.airbnb.com/admin/trips/reservation?id=" + resid,
        options = {
            "shotSize": "all",
            "cookies": cookies,
            "errorIfStatusIsNot200": true
        };

    console.log("Fetching " + url);
    webshot(url, outputFile, options, function(err){
        if (err) {
            console.error(err);
        } else {
            console.log("Screenshot saved to " + outputFile);
        }
        callback();
    });
});
