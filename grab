#!/usr/bin/env node
var fs = require('fs');
    child_process = require('child_process'),
    path = require('path'),
    async = require('async'), 
    webshot = require('webshot');

var usage = "Usage $0 <inputfile> <outputdir>",
    argv = require('yargs')
    .usage(usage)
    .help("h")
    .alias("h", "help")
    .demand(2, "You must supply and input file and and output directory")
    .describe("c", "cookie file (output from Cookie Inspector export)")
    .alias("c", "cookie-jar")
    .describe("b", "base url to start with, resid will be appended to the end")
    .alias("b", "base-url")
    .default("b", "https://admin.airbnb.com/admin/trips/reservation?id=")
    .boolean('v')
    .describe("v", "More output")
    .alias("v", "verbose")
    .argv;

var inputFile = argv._[0];
if (! fs.existsSync(inputFile)) {
    console.log("Input file '" + inputFile + "' does not exist");
    process.exit()
}


var outputDir = argv._[1];
if (! fs.existsSync(outputDir)) {
    console.log("Output directory does not exist, creating it.");
    fs.mkdirSync(outputDir);
}

function parseCookieFile(file) {
    // Takes a file generated by Edit This Cookie
    var fullFile = path.resolve(file), // make it absolute
        cookies = require(fullFile);
    return cookies;
}
var cookies = argv.c ? parseCookieFile(argv.c) : [];

var resids = fs.readFileSync(inputFile).toString().split("\n");
resids.shift(); // first one is the CSV header

async.eachSeries(resids, function (resid, callback) {
    resid = resid.trim()
    console.log("Grabbing reservation '" + resid + "'");
    var outputFile = outputDir + '/' + resid + '.png',
        url = argv.b + resid,
        options = {
            "shotSize": "all",
            "cookies": cookies,
            "errorIfStatusIsNot200": true,
            "phantomConfig": { "disk-cache": 'true'},
            "timeout": 30 * 1000
        };

    console.log("Fetching " + url);
    webshot(url, outputFile, options, function(err){
        if (err) {
            console.error(err);
        } else {
            console.log("Screenshot saved to " + outputFile);
        }
        callback();
    });
});
